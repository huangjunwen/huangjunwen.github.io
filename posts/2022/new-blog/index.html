<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>新博客</title>
    
    <link rel="stylesheet" href="/res/libs/fontawesome/css/all.min.css"></link>
    <link rel="stylesheet" href="/res/libs/chota/css/chota.min.css"></link>
    <link rel="stylesheet" href="/res/style/site.min.1cfb2065638c6eda7f5ceb0b60110baf5593ae09a1298e64096971386bd084ca.css"></link>
    <script type="text/javascript" src="/res/script/site.min.6881188133395162222bed24f23dd6cbdd74f0b93a54b35a6b929b5178e10fe9.js"></script>
    <link id="markdown-body-style" rel="stylesheet" href="/res/style/markdown-body.min.d312d9f13f8c0bc92f4ce5c8b2f23bc1ee35c4f43af65da316403e3c7d8c9624.css"></link>
    <script type="text/javascript" src="/res/script/markdown-body.min.a6a10b3328945990fade36e6fee4eab6131402292da617dc8c6d0258507f0c72.js"></script>
  </head>

  <body>
    
    <div id="header">
      
      <nav id="navbar" class="row">
        <div class="is-left col-12 col-3-md row">
          <a id="navbar-brand" class="brand" href="/">Coder Papa</a>
          <label id="navbar-toggle-menu" for="navbar-toggle-menu-state" class="hide-md hide-lg">
            <span></span>
            <span></span>
            <span></span>
          </label>
        </div>
        <input id="navbar-toggle-menu-state" type="checkbox" style="display:none"></input>
        <div id="navbar-menu" class="is-right col-12 col-9-md row hide-xs-noimportant hide-sm-noimportant">
          
          <a href="/posts">Posts</a>
          
          <a href="/notes">Notes</a>
          
          
          <a href="/tags">Tags</a>
          
          
          <a href="https://github.com/huangjunwen"><i class='fab fa-github'></i></a>
          
          <a href="javascript:void(0)" id="navbar-toggle-mode" onclick="return toggleColorMode()"></a>
        </div>
      </nav>
    </div>

    
    <div id="main" class="row">
      <div id="main-left" class="hide-xs hide-sm col-2-md col-3-lg">
        
      </div>
      <div id="main-center" class="col-12 col-8-md col-6-lg mdb">
        <div id="main-title" class="text-center">
          
  <h5 class="no-toc"><span class="breadcrumbnav"><span><a href="/posts/">POSTS</a></span><i class="fa fa-fw fa-angle-double-right"></i><span><a href="/posts/2022/">2022</a></span></span></h5>
  <h1>新博客</h1>
  <small>
    <time class="" datetime="2022-02-19T09:24:49Z">Sat, 2022/02/19</time>
  </small>
  <p>
    
    <a href="/tags/tool/"><span class="tag is-small">tool</span></a>
  </p>
  
        </div>
        <div id="main-body">
          
  <article id="content-body">
    <p>花了<strong>相当相当多</strong>时间重新建设自己的内容管理系统，总算大致完成（<a
href="https://github.com/huangjunwen/mdtool"
class="uri">https://github.com/huangjunwen/mdtool</a>），记录一下</p>
<h2 id="需求">需求</h2>
<p>大致如下</p>
<ol type="1">
<li>内容应该可以很容易跨平台发布，例如除了本身作为博客的网站外，也能发布到微信公众号或其他内容平台，
甚至可以单独输出成文档</li>
<li>写作时要有实时反馈</li>
<li>内容使用的格式不能过于依赖专有或特定软件</li>
<li>仅使用开源工具</li>
</ol>
<h2 id="格式">格式</h2>
<h3 id="markdown">Markdown</h3>
<p>熟悉，简单，广泛应用</p>
<ul>
<li><a href="https://www.markdownguide.org/basic-syntax/"
class="uri">https://www.markdownguide.org/basic-syntax/</a></li>
<li><a href="https://www.markdownguide.org/extended-syntax/"
class="uri">https://www.markdownguide.org/extended-syntax/</a></li>
</ul>
<h3 id="tex">Tex</h3>
<p>功能强大，表达丰富，不过需要些时间学习；另外 markdown 中也可以嵌入
math mode 的公式，这已经解决很大一部分问题了</p>
<h3 id="svg">Svg</h3>
<p>配图首选，缩放无损，文本可编辑，众多编辑器可用<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<h2 id="工具">工具</h2>
<h3 id="hugo">Hugo</h3>
<p>速度快，编辑即可看到效果</p>
<h3 id="pandoc">Pandoc</h3>
<p>pandoc 也是可以作为 hugo 的 markdown 渲染引擎的 <a href="#fn2"
class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a>，用它有多个好处</p>
<ul>
<li>能识别 latex 式的 math mode（<code
class="language-plaintext">$...$</code>/<code
class="language-plaintext">$$...$$</code>）</li>
<li>可以写 filter！用 <a
href="https://pandoc.org/filters.html">外部程序</a> 或者 <a
href="https://pandoc.org/lua-filters.html">lua 脚本</a> 直接修改 pandoc
的 ast</li>
<li>pandoc 本身就是用来转换格式的（e.g. markdown -&gt; pdf）</li>
<li>更多扩展</li>
</ul>
<h2 id="整合">整合</h2>
<p>整合起来就是：<strong>内容为 markdown
格式，尽量少使用专有的扩展，pandoc 负责将其转换格式，其中最主要的 html
格式则交由 hugo + js + css 进一步处理及呈现</strong></p>
<p>一些实现细节：</p>
<ul>
<li>hugo 调起 pandoc 的命令行很简单： <code
class="language-plaintext">pandoc --mathjax</code>，因此需要自己写一个也叫做
<code class="language-plaintext">pandoc</code> 的 shell 脚本并放置到
<code class="language-plaintext">$PATH</code>
更优先的地方，在其中可添加更多的参数（e.g. 添加 filter）</li>
<li>一开始是在 pandoc filter 里用 prismjs/mathjax
对语法高亮/数学公式进行服务端渲染，完成后发现太慢了，后来还是改回客户端渲染</li>
<li>微信公众号对 css 有巨多限制，给调试样式添加了很多麻烦</li>
</ul>
<h3 id="assets">assets</h3>
<p>有时图片或其他 asset 需要由别的格式转换而成（e.g. graphviz 的 dot
转换为 png），
可以简单写个脚本监听文件变化然后进行处理，例如下面是一个将 ipe
格式的文件转换为 svg/png 的脚本， 用到 <code
class="language-plaintext">iperender</code> 和 <code
class="language-plaintext">inkscape</code> 对图片进行处理，<code
class="language-plaintext">inotifywait</code> 监听变化时执行 （这里用
inkscape 主要是将 svg 中的所有 id 去掉，以适配微信公众号环境）</p>
<pre class="language-sh"><code>#!/bin/bash

# gen-img.sh

ipe2svg () {
  # *.svg.ipe -&gt; *.svg
  local src=$1
  local target=${src%.ipe}
  if [ $src -nt $target ]; then
    iperender -svg $src /dev/stdout | \
      inkscape -lp --export-filename=- --actions=&quot;select-all:all;clone-unlink-recursively&quot; --vacuum-defs | \
      sed &#39;s/rgb(0\%,0\%,0\%)/currentColor/g&#39; &gt; $target
    echo &quot;$target is regenerated&quot;
  else
    echo &quot;$target is already up-to-date&quot;
  fi
}

ipe2png () {
  # *.png.ipe -&gt; *.png
  local src=$1
  local target=${src%.ipe}
  if [ $src -nt $target ]; then
    iperender -png -resolution 256 $src $target
    echo &quot;$target is regenerated&quot;
  else
    echo &quot;$target is already up-to-date&quot;
  fi
}

find . -name &#39;*.svg.ipe&#39; -print | while read file; do \
  ipe2svg $file; \
done

find . -name &#39;*.png.ipe&#39; -print | while read file; do \
  ipe2png $file; \
done

inotifywait -rmq -e close_write,moved_to . | while read dir action file; do \
  case $file in
    *.svg.ipe)
      ipe2svg $dir/$file
      ;;
    *.png.ipe)
      ipe2png $dir/$file
  esac
done</code></pre>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>如 <a
href="https://inkscape.org/">inkscape</a>，<a
href="https://ipe.otfried.org/">ipe extensible drawing editor</a> 等<a
href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><a
href="https://gohugo.io/content-management/formats/"
class="uri">https://gohugo.io/content-management/formats/</a> <a
href="https://graemephi.github.io/posts/static-katex-with-hugo/"
class="uri">https://graemephi.github.io/posts/static-katex-with-hugo/</a><a
href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

  </article>

        </div>
      </div>
      <div id="main-right" class="hide-xs hide-sm col-2-md col-3-lg">
        
  
  <div id="content-toc" class="toc hide-md"></div>
  

      </div>
    </div>

    
    <div id="footer" class="text-center">
      <p>
        Powered By <a href="https://gohugo.io/">Hugo</a>/<a href="https://jenil.github.io/chota">Chota</a>,
        Generated Using <a href="https://github.com/huangjunwen/mdtool">MDTool</a>
      </p>
      <p>&copy; 2022. All rights reserved</p>
    </div>

    
  
    <link rel="stylesheet" href="/res/libs/tocbot/css/tocbot.css"></link>
    <style>
    #content-toc {
      position: -webkit-sticky;
      position: sticky;
      top: 7rem;
      padding-left: 2rem;
      padding-right: 1rem;
    }

    #content-toc a.toc-link {
      color: var(--font-color);
    }

    #content-toc a.toc-link.is-active-link {
      color: var(--color-darkGrey);
    }

    #content-toc a.toc-link::before {
      background-color: var(--bg-color);
    }

    #content-toc a.toc-link.is-active-link::before {
      background-color: var(--color-primary);
    }
    </style>
    <script src="/res/libs/tocbot/js/tocbot.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', (ev) => {
      tocbot.init({
        tocSelector: '#content-toc',
        contentSelector: '#main-center',
        ignoreSelector: '.no-toc',
        headingSelector: 'h1, h2, h3, h4, h5, h6',
        hasInnerContainers: false,
        headingsOffset: 80,
        scrollSmoothOffset: -80
      });
    });
    </script>
  
  
    <script type="text/javascript" src="/res/libs/anchorjs/js/anchor.min.js"></script>
    <script>anchors.add('#main-body h1, #main-body h2, #main-body h3, #main-body h4, #main-body h5, #main-body h6, #main-body dt');</script>
  

  </body>
</html>
